name: Tidy Checks

on:
  push:
    branches:
    - master
  pull_request:
    branches:
    - master

jobs:
  RunClangTidy:
    runs-on: ubuntu-24.04
    steps:

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install dependencies
      run: |
        sudo ./scripts/uni-get-dependencies.sh
        sudo apt -qq -y install clang-tidy

    - name: Run CMake
      run: cmake -S . -B build -GNinja

    - name: Build autogenerated files
      run: ninja -C build CMakeFiles/OpenSCAD_autogen

    - name: Retrieve cached results
      uses: actions/cache@v4
      with:
        path: /root/.cache/clang-tidy
        key: clang-tidy

    - name: Run ClangTidy
      run: |
        ln -s build/compile_commands.json .
        # Since we're not 'clean' yet, or with 'true' to not fail CI, but
        # at least the output will provide a report
        scripts/run-clang-tidy-cached.cc || true
